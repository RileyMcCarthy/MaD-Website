{% extends "base.html" %}
{% block title %}Status{% endblock %}
{% block content %}

<div class="container">
    <div class="container m-3">
        <h1>Motion Profile</h1>
        <button onclick=editForm()>Modify</button>
        <a href="{{url_for('settings_default')}}"><button>Load Template</button></a>
        <div class="container rounded bg-light p-3">
            <form id = "machineProfile" method="post" style="display: none;">
                <fieldset id="formEnable" {% if not editable %}disabled{% else %}{% endif %}>
                    {{ render_form(form) }}
                    <button type="submit">Submit</button>
                </fieldset>
            </form>
        </div>
        <p id="loading">Loading</p>
    </div>
</div>

<script>

function editForm() {
    console.log("Edit Form")
    $('#formEnable').removeAttr('disabled');
};

$(document).ready(function () {

    function setFormErrors(form, json) {
        for (var key in json)
        {
            var input = form.find('#' + key + '-error');
            if (input)
            {
                input.html(json[key]);
            }
        }
    };

    function clearErrors(form) {
        form.find('.error').html('');
    };

    $('#machineProfile').submit(function (e) {
        var url = "{{ url_for('settings_save') }}"; // send the form data here.
        $.ajax({
            type: "POST",
            url: url,
            data: $('#machineProfile').serialize(), // serializes the form's elements.
            success: function (data) {
                console.log(data)  // display the returned data in the console.
                clearErrors($('#machineProfile'));
                window.alert(data);
            },
            error: function (data) {
                if (!data || !data.responseJSON)
                {
                    return; // Invalid data
                }
                console.log(data)
                var machineProfile = $('#machineProfile');
                setFormErrors(machineProfile, data.responseJSON)
            }
        });
        e.preventDefault(); // block the traditional submission of the form.
    });

    // Inject our CSRF token into our AJAX request.
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", "{{ form.csrf_token._value() }}")
            }
        }
    })

    var socket = io('/serial');
    
    socket.emit('profile');

    socket.on('profile', function (data) {
        console.log(data);
        if (!data || !data.json)
        {
            return; // Invalid data
        }
        
        // Only update the form if we are not currently editing it
        if ($('#formEnable').has('disabled'))
        {
            var json = JSON.parse(data.json);
            var machineProfile = $('#machineProfile');
            for (var key in json)
            {
                var input = machineProfile.find('#' + key);
                if (input)
                {
                    input.val(json[key]);
                }
            }
        }
        $('#machineProfile').show();
        $('#loading').hide();
    });
});
</script>

{% endblock %}