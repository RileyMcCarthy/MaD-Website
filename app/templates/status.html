{% extends "base.html" %}
{% block title %}Status{% endblock %}
{% block content %}
<div class="container my-3">
    <div class="row">
        <div class="col-xl-4">
            <div class="row-xl mb-3">
                <div class="shadow p-3 bg-white rounded">
                    <div class="container" id="machineState">
                        {% macro display_header(header,id) %}
                        <div class="row">
                            <h3 class="text-primary" json-id="{{id}}">{{header}}</h3>
                        </div>
                        {% endmacro %}
                        {% macro display_boolean(label,id) %}
                        <div class="row d-flex">
                            <div class="col-8">
                                <h5>{{label}}</h5>
                            </div>
                            <div class="col">
                                <div class="ml-auto align-middle">
                                    <i json-id="{{id}}"class="bi-x-square"></i>
                                </div>
                            </div>
                        </div>
                        {% endmacro %}
                        {% macro display_value(label,id) %}
                        <div class="row d-flex">
                            <div class="col">
                                <h5>{{label}}</h5>
                            </div>
                            <div class="col ml-auto">
                                <span type="text" json-id="{{id}}" class="align-middle"></span>
                            </div>
                        </div>
                        {% endmacro %}
                        {% macro display_button(label,id, func, class) %}
                        <div class="row d-flex">
                            <div class="col">
                                <h5>{{label}}</h5>
                            </div>
                            <div class="col ml-auto">
                                <button type="button" json-id="{{id}}" class="btn {{class}}" onclick={{func}}></button>
                            </div>
                        </div>
                        {% endmacro %}
                        {{display_header("Self check","selfCheckParameters")}}
                        {{display_boolean("Charge Pump","chargePump")}}

                        {{display_header("Machine Check","machineCheckParameters")}}
                        {{display_boolean("Switch Power","switchedPower")}}
                        {{display_value("ESD Travel","esdTravelLimit")}}
                        {{display_boolean("ESD Switch","esdSwitch")}}
                        {{display_boolean("Servo Ready","servoOK")}}
                        {{display_boolean("Force Comm","forceGaugeCom")}}
                        {{display_boolean("Servo Comm","servoCom")}}

                        {{display_header("Motion","motionParameters")}}
                        {{display_button("Status","status", "toggleStatus()", "btn-success")}}
                        {{display_value("Condition","condition")}}
                        {{display_button("Mode","mode", "toggleMode()", "btn-success")}}
                        {{display_button("","Run", "run()", "btn-success")}}
                    </div>
                </div>
            </div>
            <div class="row-xl shadow p-3 mb-3 bg-white rounded text-center">
                <div class="row-xl">
                    <div class="row-xl">
                        <div class="col">
                            <h3>Control</h3>
                        </div>
                    </div>
                    <div class="row-xl">
                        <div class="col" id="functions">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl">
            <div class="row-xl">
                <div class="shadow p-3 mb-3 bg-white rounded">
                    <div id="chart-position" style="height: 370px; width:100%;"></div>
                </div>
            </div>
            <div class="row-xl">
                <div class="shadow p-3 mb-3 bg-white rounded">
                    <div id="chart-force" style="height: 370px; width:100%;"></div>
                </div>
            </div>
            <div class="row-xl">
                <div class="shadow p-3 mb-3 bg-white rounded">
                    <canvas id="chart-tension" style="width:100%;"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript">

    function update_boolean(id, value) {
        if (value) {
            $(`[json-id="${id}"]`).attr("class", "bi-check-square-fill");
        } else {
            $(`[json-id="${id}"]`).attr("class", "bi-x-square");
        }
    };

    function update_value(id, value) {
        $(`[json-id="${id}"]`).html(value);
    };

    function get_value(id) {
        return $(`[json-id="${id}"]`).html();
    };

    function update_header(id, value) {
        if (value) {
            $(`[json-id="${id}"]`).attr("class", "text-success");
        } else {
            $(`[json-id="${id}"]`).attr("class", "text-danger");
        }
    };

    function run() {
        $.ajax({
            url: "/run",
            type: "post",
            success: function (data) {
                console.log("Running default motion profile");
            },
            error: function (xhr) {
                //Handel error
            }
        });
    };

    function toggleStatus() {
        $.ajax({
            url: "/toggleStatus",
            type: "post",
            contentType: "application/json",
            data: JSON.stringify({status: get_value("status")}),
            success: function (data) {
                console.log("Toggling Status");
            },
            error: function (xhr) {
                //Handel error
            }
        });
    };

    function toggleMode() {
        $.ajax({
            url: "/toggleMode",
            type: "post",
            contentType: "application/json",
            data: JSON.stringify({mode: get_value("mode")}),
            success: function (data) {
                console.log("Toggling Mode");
            },
            error: function (xhr) {
                //Handel error
            }
        });
    };

    $(document).ready(function () {

        var chartPositionData = []; // dataPoints
        var chartPosition = new CanvasJS.Chart("chart-position", {
            
            title :{
                text: "Position"
            },
            data: [{
                type: "line",
                dataPoints: chartPositionData
            }],
            axisX:{
                gridThickness: 0,
                tickLength: 0,
                lineThickness: 0,
                labelFormatter: function(){
                return " ";
                }
            }
        });

        var chartForceData = []; // dataPoints
        var chartForce = new CanvasJS.Chart("chart-force", {
            
            title :{
                text: "Force"
            },
            data: [{
                type: "line",
                dataPoints: chartForceData
            }],
            axisX:{
                gridThickness: 0,
                tickLength: 0,
                lineThickness: 0,
                labelFormatter: function(){
                return " ";
                }
            }
        });

        var socket = io('/serial');
        var max = 1000;
        socket.on('data', function (data) {
            if (!data) {
                return;
            }
            
            var monitor = JSON.parse(data.json);

            var time = monitor['Time']/1000000.0;
            var positionmm = monitor['Position']/1000.0;
            var force = monitor['Force']/1000.0;
            var setpointmm = monitor['Setpoint']/1000.0;
            console.log(time, positionmm, force, setpointmm);

            chartPositionData.push({
                    x: time,
                    y: positionmm
                });
            if (chartPositionData.length > max) {
                chartPositionData.shift();
            }
            chartPosition.render();

            chartForceData.push({
                    x: time,
                    y: force
                });
            if (chartForceData.length > max) {
                chartForceData.shift();
            }
            chartForce.render();

        });

        socket.on('state', function (data) {
            if (!data && !data.json) {
                return;
            } 

            json = JSON.parse(data.json);
            
            state = json['State']
            
            selfCheck = json['Self Check Parameters'];
            chargePump = selfCheck['Charge Pump'];

            machineCheckParameters = json['Machine Check Parameters'];
            switchedPower = machineCheckParameters['Switched Power'];
            esdTravelLimit = machineCheckParameters['ESD Travel Limit'];
            esdSwitch = machineCheckParameters['ESD Switch'];
            servoOK = machineCheckParameters['Servo OK'];
            forceGaugeCom = machineCheckParameters['Force Gauge Com'];
            servoCom = machineCheckParameters['Servo Com'];

            motionParameters = json['Motion Parameters'];
            status = motionParameters['Status'];
            condition = motionParameters['Condition'];
            mode = motionParameters['Mode'];

            console.log(selfCheck);
            update_header("selfCheckParameters", state !=0);
            update_boolean("chargePump", chargePump);
        
            machineCheck = json.machineCheckParameters;
            update_header("machineCheckParameters", state!=0&&state!=1);
            update_boolean("switchedPower", switchedPower);
            update_value("esdTravelLimit", esdTravelLimit);
            update_boolean("esdSwitch", esdSwitch);
            update_boolean("servoOK", servoOK);
            update_boolean("forceGaugeCom", forceGaugeCom);
            update_boolean("servoCom", servoCom);

            motionParameters = json.motionParameters;
            update_value("status", status);
            update_value("condition", condition);
            update_value("mode", mode);

            //$(`[json-id="status"]`).prop('disabled', "2".localeCompare(json.state));
        });
    });
</script>

{% endblock %}